{% extends "base.html" %}

{% block title %}
{% if current_car %}My Garage - {{ current_car.template.name }}{% else %}My Garage{% endif %}
{% endblock %}

{% block content %}

{% if not current_car %}
    <!-- No Current Car - Go to Junkyard -->
    <div class="text-center py-12">
        <div class="text-6xl mb-6">üè≠</div>
        <h2 class="text-2xl font-bold text-gray-400 mb-4">Your Garage is Empty</h2>
        <p class="text-gray-500 mb-6">Time to find a project car!</p>
        <a href="{{ url_for('junkyard') }}" 
           class="bg-neon-cyan hover:bg-cyan-400 text-garage-darker font-bold py-3 px-6 rounded-lg inline-block neon-pulse">
            üöó Visit Junkyard
        </a>
    </div>
    
    <!-- Showroom (Completed Cars) -->
    {% if completed_cars %}
    <div class="mt-12">
        <h3 class="text-xl font-bold text-neon-amber mb-4 text-center">üèÜ SHOWROOM</h3>
        <div class="space-y-3">
            {% for car in completed_cars %}
            <div class="bg-gradient-to-r from-neon-amber/10 to-neon-cyan/10 border border-neon-amber/50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-bold text-neon-amber">{{ car.car_model.replace('_', ' ').title() }}</h4>
                        <p class="text-xs text-gray-400">Completed {{ car.completed_at.strftime('%b %d') if car.completed_at else 'Recently' }}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl mb-1">‚ú®</div>
                        <div class="text-xs text-engine-silver">{{ (car.total_focus_minutes / 60)|round(1) }}h</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

{% else %}
    <!-- Current Car Display -->
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-neon-cyan font-racing">{{ current_car.template.name }}</h2>
        <p class="text-gray-400">{{ current_car.car_model.replace('_', ' ').title() }}</p>
    </div>

    <!-- Car Visual with 3D Viewer -->
    <div class="car-container mb-6">
        <!-- Car stages based on progress -->
        {% set progress = current_car.restoration_progress %}
        {% set current_stage = 0 %}
        {% for stage in current_car.template.stages %}
            {% if progress >= stage.threshold %}
                {% set current_stage = loop.index0 %}
            {% endif %}
        {% endfor %}
        
        <div class="relative bg-garage-dark border-2 border-gray-600 rounded-xl p-6">
            <!-- 3D Car Viewer Container -->
            <div id="car-3d-viewer" class="w-full h-64 rounded-lg relative overflow-hidden">
                <!-- Loading state -->
                <div class="absolute inset-0 flex items-center justify-center bg-garage-darker">
                    <div class="text-center">
                        <div class="text-4xl mb-2">‚öôÔ∏è</div>
                        <div class="text-neon-cyan">Initializing 3D Viewer...</div>
                    </div>
                </div>
            </div>
            
            <!-- 3D Controls -->
            <div class="mt-4 flex justify-center space-x-4">
                <button id="toggle-rotation" class="bg-garage-darker border border-gray-600 rounded-lg px-3 py-2 text-sm hover:border-neon-cyan transition-colors">
                    üîÑ Auto Rotate
                </button>
                <button id="reset-view" class="bg-garage-darker border border-gray-600 rounded-lg px-3 py-2 text-sm hover:border-neon-cyan transition-colors">
                    üéØ Reset View
                </button>
                <button id="toggle-view" class="bg-garage-darker border border-gray-600 rounded-lg px-3 py-2 text-sm hover:border-neon-cyan transition-colors">
                    üì∑ 2D/3D View
                </button>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-4">
                <div class="flex justify-between text-sm text-gray-400 mb-2">
                    <span>Restoration Progress</span>
                    <span>{{ "%.1f"|format(progress) }}%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3">
                    <div class="bg-gradient-to-r from-rust-red via-neon-amber to-neon-cyan h-3 rounded-full transition-all duration-500"
                         style="width: {{ progress }}%"></div>
                </div>
                {% if progress < 100 %}
                    <div class="text-xs text-gray-500 mt-1 text-center">
                        Next milestone: {{ current_car.template.stages[current_stage + 1].description if current_stage + 1 < current_car.template.stages|length else 'Showroom Ready!' }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-garage-dark border border-gray-600 rounded-lg p-4 text-center">
            <div class="text-2xl text-neon-amber mb-2">‚è±Ô∏è</div>
            <div class="text-lg font-bold text-white">{{ (current_car.total_focus_minutes / 60)|round(1) }}</div>
            <div class="text-xs text-gray-400">Hours Focused</div>
        </div>
        <div class="bg-garage-dark border border-gray-600 rounded-lg p-4 text-center">
            <div class="text-2xl text-neon-cyan mb-2">üî©</div>
            <div class="text-lg font-bold text-white">{{ user.scrap_metal }}</div>
            <div class="text-xs text-gray-400">Scrap Metal</div>
        </div>
    </div>

    <!-- Focus Session Setup -->
    <div class="bg-garage-dark border border-neon-cyan/30 rounded-lg p-6 mb-6">
        <h3 class="text-lg font-bold text-neon-cyan mb-4 text-center">üîß START WORKING</h3>
        
        <form id="session-form" class="space-y-4">
            <div>
                <label for="task-input" class="block text-sm font-medium text-gray-300 mb-2">
                    What are you working on?
                </label>
                <input type="text" id="task-input" 
                       class="w-full px-4 py-3 bg-garage-darker border border-gray-600 rounded-lg 
                              focus:border-neon-cyan focus:ring-2 focus:ring-neon-cyan/20 
                              text-white placeholder-gray-400"
                       placeholder="e.g., Study calculus, Read chapter 5..."
                       required>
            </div>
            
            <div>
                <label for="duration-select" class="block text-sm font-medium text-gray-300 mb-2">
                    Session Duration
                </label>
                <select id="duration-select" 
                        class="w-full px-4 py-3 bg-garage-darker border border-gray-600 rounded-lg 
                               focus:border-neon-cyan focus:ring-2 focus:ring-neon-cyan/20 text-white">
                    <option value="5">5 minutes - Quick check</option>
                    <option value="10">10 minutes - Mini session</option>
                    <option value="15">15 minutes - Quick tune-up</option>
                    <option value="25" selected>25 minutes - Standard session</option>
                    <option value="45">45 minutes - Deep work</option>
                    <option value="60">60 minutes - Marathon</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Timer Mode
                </label>
                <div class="space-y-2">
                    <label class="flex items-center p-3 bg-garage-darker border border-gray-600 rounded-lg cursor-pointer hover:border-neon-amber transition-colors">
                        <input type="radio" name="timer-mode" value="focus" id="focus-mode" checked 
                               class="text-neon-amber focus:ring-neon-amber/20 bg-garage-darker border-gray-600">
                        <div class="ml-3">
                            <div class="text-neon-amber font-semibold">üîí Focus Mode</div>
                            <div class="text-xs text-gray-400">Stay on tab - leave = warning + failure</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 bg-garage-darker border border-gray-600 rounded-lg cursor-pointer hover:border-neon-cyan transition-colors">
                        <input type="radio" name="timer-mode" value="background" id="background-mode"
                               class="text-neon-cyan focus:ring-neon-cyan/20 bg-garage-darker border-gray-600">
                        <div class="ml-3">
                            <div class="text-neon-cyan font-semibold">üì± Background Mode</div>
                            <div class="text-xs text-gray-400">Switch tabs freely - timer runs in background</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div id="mode-info" class="rounded p-3 text-sm transition-all duration-300">
                <!-- Dynamic mode information will be inserted here -->
            </div>
        </form>
    </div>

    <!-- Completed Car Success -->
    {% if progress >= 100 %}
    <div class="bg-gradient-to-r from-neon-amber/20 to-neon-cyan/20 border-2 border-neon-amber rounded-lg p-6 text-center mb-6">
        <div class="text-4xl mb-3">üéâ</div>
        <h3 class="text-xl font-bold text-neon-amber mb-2">RESTORATION COMPLETE!</h3>
        <p class="text-gray-300 mb-4">{{ current_car.template.name }} is showroom ready!</p>
        <a href="{{ url_for('junkyard') }}" 
           class="bg-neon-cyan hover:bg-cyan-400 text-garage-darker font-bold py-2 px-6 rounded-lg inline-block">
            üöó Find Next Project
        </a>
    </div>
    {% endif %}

{% endif %}

<!-- Floating Action Button -->
{% if current_car and current_car.restoration_progress < 100 %}
<button id="start-focus-btn" 
        class="floating-button bg-neon-cyan hover:bg-cyan-400 text-garage-darker 
               font-bold py-4 px-8 rounded-full shadow-lg neon-pulse">
    üîß START ENGINE
</button>
{% endif %}

{% endblock %}

{% block scripts %}
<!-- Three.js for 3D car viewer -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/controls/OrbitControls.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/loaders/GLTFLoader.js"></script>
<script src="/static/js/car-viewer-3d.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Focus session handling
    const startBtn = document.getElementById('start-focus-btn');
    const sessionForm = document.getElementById('session-form');
    const taskInput = document.getElementById('task-input');
    const durationSelect = document.getElementById('duration-select');
    
    // Timer mode handling
    const focusModeRadio = document.getElementById('focus-mode');
    const backgroundModeRadio = document.getElementById('background-mode');
    const modeInfoDiv = document.getElementById('mode-info');
    
    function updateModeInfo() {
        const selectedMode = document.querySelector('input[name="timer-mode"]:checked').value;
        
        if (selectedMode === 'focus') {
            modeInfoDiv.innerHTML = `
                <div class="bg-neon-amber/10 border border-neon-amber/30">
                    <p class="text-neon-amber font-semibold mb-1">üîí Focus Rules:</p>
                    <ul class="text-gray-300 text-xs space-y-1">
                        <li>‚Ä¢ Stay on this tab during the session</li>
                        <li>‚Ä¢ Switch tabs = 10 second warning</li>
                        <li>‚Ä¢ Don't return in time = session fails!</li>
                        <li>‚Ä¢ Complete session = earn scrap metal + progress</li>
                    </ul>
                </div>
            `;
        } else {
            modeInfoDiv.innerHTML = `
                <div class="bg-neon-cyan/10 border border-neon-cyan/30">
                    <p class="text-neon-cyan font-semibold mb-1">üì± Background Rules:</p>
                    <ul class="text-gray-300 text-xs space-y-1">
                        <li>‚Ä¢ Switch tabs freely - timer keeps running</li>
                        <li>‚Ä¢ Works across browser tabs and apps</li>
                        <li>‚Ä¢ No penalties for leaving the page</li>
                        <li>‚Ä¢ Complete session = earn scrap metal + progress</li>
                    </ul>
                </div>
            `;
        }
    }
    
    if (focusModeRadio && backgroundModeRadio) {
        focusModeRadio.addEventListener('change', updateModeInfo);
        backgroundModeRadio.addEventListener('change', updateModeInfo);
        updateModeInfo(); // Initial update
    }

    if (startBtn && sessionForm) {
        startBtn.addEventListener('click', function() {
            const task = taskInput.value.trim();
            const duration = parseInt(durationSelect.value);
            const selectedMode = document.querySelector('input[name="timer-mode"]:checked').value;
            
            if (!task) {
                alert('Please enter what you are working on!');
                taskInput.focus();
                return;
            }
            
            // Start session with selected mode
            window.focusTimer.startSession(task, duration, selectedMode);
        });
        
        // Allow Enter key to start session
        taskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                startBtn.click();
            }
        });
    }

    // Initialize 3D car viewer for current car
    const carViewerContainer = document.getElementById('car-3d-viewer');
    if (carViewerContainer) {
        let carViewer = null;
        
        // Get car data from DOM attributes
        const carData = {
            {% if current_car %}
            progress: {{ current_car.restoration_progress|round(2) }},
            modelId: {{ current_car.car_model|tojson }},
            hasCurrentCar: true
            {% else %}
            hasCurrentCar: false
            {% endif %}
        };
        
        if (carData.hasCurrentCar) {
            // Initialize viewer with fallback
            function initCarViewer() {
                try {
                    carViewer = new Car3DViewer('car-3d-viewer', {
                        enableControls: true,
                        autoRotate: false,
                        height: 256
                    });
                    
                    // Load model data
                    fetch('/api/car_3d/' + carData.modelId + '?progress=' + carData.progress)
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.model_3d_url && data.model_3d_url.length > 0) {
                                carViewer.loadCarModel(data.model_3d_url, carData.progress);
                            } else {
                                carViewer.updateProgress(carData.progress);
                            }
                        })
                        .catch(function(error) {
                            console.warn('Failed to load 3D model:', error);
                            carViewer.updateProgress(carData.progress);
                        });
                        
                } catch (error) {
                    console.warn('3D viewer initialization failed:', error);
                    // Show fallback view
                    document.getElementById('car-3d-viewer').innerHTML = 
                        '<div class="fallback-viewer w-full h-full flex items-center justify-center bg-garage-dark rounded-lg">' +
                        '<div class="text-center">' +
                        '<div class="text-6xl mb-4">üöó</div>' +
                        '<p class="text-gray-400">3D viewer not available</p>' +
                        '</div></div>';
                }
            }

            // Setup control handlers
            function setupControls() {
                const toggleRotation = document.getElementById('toggle-rotation');
                const resetView = document.getElementById('reset-view');
                const toggleView = document.getElementById('toggle-view');

                if (toggleRotation) {
                    toggleRotation.addEventListener('click', function() {
                        if (carViewer && carViewer.controls) {
                            carViewer.controls.autoRotate = !carViewer.controls.autoRotate;
                            this.style.borderColor = carViewer.controls.autoRotate ? '#00d9ff' : '#4b5563';
                        }
                    });
                }

                if (resetView) {
                    resetView.addEventListener('click', function() {
                        if (carViewer && carViewer.controls) {
                            carViewer.controls.reset();
                        }
                    });
                }

                if (toggleView) {
                    toggleView.addEventListener('click', function() {
                        if (carViewer) {
                            carViewer.enableFallback();
                            carViewer.updateProgress(carData.progress);
                        }
                    });
                }
            }

            // Initialize everything
            setTimeout(function() {
                initCarViewer();
                setTimeout(setupControls, 500);
            }, 100);
        }
    }

    // Handle session completion
    if (window.focusTimer && window.focusTimer.stopSession) {
        const originalStop = window.focusTimer.stopSession;
        window.focusTimer.stopSession = function(success) {
            originalStop.call(this, success);
            if (success) {
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
            }
        };
    }
});
</script>
{% endblock %}
